# 负载均衡配置示例

auth:
  default_auth:
    api_keys:
      - "sk-prod-key-1"

# 多上游服务器配置
models:
  # 示例1: 轮询策略（默认）
  gpt-3.5-turbo:
    # 使用 upstreams 配置多个上游服务器
    upstreams:
      - api_base: "https://api.openai.com/v1"
        api_key: "sk-openai-key-1"
        weight: 1
        timeout: 60
      
      - api_base: "https://api.openai-proxy1.com/v1"
        api_key: "sk-proxy1-key"
        weight: 1
        timeout: 60
      
      - api_base: "https://api.openai-proxy2.com/v1"
        api_key: "sk-proxy2-key"
        weight: 1
        timeout: 60
    
    # 负载均衡策略：round_robin（轮询）, random（随机）, weighted（权重）, least_connections（最少连接）
    load_balance_strategy: "round_robin"
    
    # 健康检查间隔（秒）
    health_check_interval: 30
    
    # 最大连续失败次数（超过后标记为不健康）
    max_failures: 3
  
  # 示例2: 权重策略
  gpt-4:
    upstreams:
      - api_base: "https://api.openai.com/v1"
        api_key: "sk-openai-key"
        weight: 5  # 权重5，获得更多流量
        timeout: 120
      
      - api_base: "https://api.openai-backup.com/v1"
        api_key: "sk-backup-key"
        weight: 1  # 权重1，作为备份
        timeout: 120
    
    load_balance_strategy: "weighted"  # 加权负载均衡
    health_check_interval: 30
    max_failures: 2
  
  # 示例3: 随机策略
  gpt-4-turbo:
    upstreams:
      - api_base: "https://api.openai.com/v1"
        api_key: "sk-openai-key"
        timeout: 120
      
      - api_base: "https://api.azure.openai.com/v1"
        api_key: "sk-azure-key"
        timeout: 120
      
      - api_base: "https://api.openai-cdn.com/v1"
        api_key: "sk-cdn-key"
        timeout: 120
    
    load_balance_strategy: "random"  # 随机选择
    health_check_interval: 60
    max_failures: 3
  
  # 示例4: 最少连接策略
  claude-3-opus:
    upstreams:
      - api_base: "https://api.anthropic.com/v1"
        api_key: "sk-ant-key-1"
        weight: 1
        timeout: 120
      
      - api_base: "https://api.anthropic-proxy.com/v1"
        api_key: "sk-ant-proxy-key"
        weight: 1
        timeout: 120
    
    load_balance_strategy: "least_connections"  # 选择连接数最少的服务器
    adapter: "anthropic"  # 需要使用 Anthropic 适配器
    health_check_interval: 30
    max_failures: 3
  
  # 示例5: 单服务器（向后兼容，不使用负载均衡）
  text-embedding-ada-002:
    api_base: "https://api.openai.com/v1"
    api_key: "sk-openai-key"
    timeout: 30

plugins:
  auth: "default_auth"
  model_route: "default_router"
  stats: ["log"]

rate_limit:
  enabled: true
  requests_per_minute: 100

# 负载均衡说明：
# 
# 1. 当配置了 upstreams 列表且包含多个服务器时，自动启用负载均衡
# 2. 支持的策略：
#    - round_robin: 轮询，依次分配到每个服务器
#    - random: 随机选择一个服务器
#    - weighted: 根据权重分配（权重越高，分配的请求越多）
#    - least_connections: 选择当前活跃连接数最少的服务器
# 
# 3. 故障转移：
#    - 当服务器连续失败达到 max_failures 次时，自动标记为不健康
#    - 不健康的服务器会被暂时跳过
#    - 健康检查会定期检查服务器状态
# 
# 4. 每个上游服务器的配置：
#    - api_base: API 基础地址
#    - api_key: API 密钥
#    - weight: 权重（仅用于 weighted 策略）
#    - timeout: 超时时间（秒）

